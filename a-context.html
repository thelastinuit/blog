<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" href="/favicon.ico">
        <title>a louise</title>
        <style>
            html, body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                display: table;
            }

            .sidebar {
                margin-top: 1ch;
            }

            .content {
                display: flex;
                margin: 0 auto;
                max-width: 80ch;
                align-items: center;
                justify-content: center;
            }
            h3 {
                margin-top: 0;
                margin-bottom: 0;
            }
            @media only screen and (max-width: 375px) {
                .content {
                    font-size: 0.85rem;
                    width: 100%;
                }
            }
            a:link,
            a:visited,
            a:hover,
            a:active {
                text-decoration:none;
                color:#333
            }

            .flex-column { flex-direction: column; }
            .inline-grid { display: inline-grid;}
            div.language-tag {
                display: block;
                float: left;
                background: #ffd1ac;
                color: #a04100;
                padding: 0.2em 0.5em;
                font-weight: bold;
                font-size: 1rem;
                border-radius: 0 0 8px 0;
            }
            pre {
                background-color: #fffcf9;
                border-radius: 4px;
                padding: 0;
                border: 1px solid #ffd1ac;
                position: relative;
            }
            article p { max-width: 80ch;}
            div.language-tag + .code-container { clear: both; }
            pre .code-container {
                padding: 0.8rem;
                line-height: 1.1;
            }
        </style>
        <link rel="stylesheet" href="style.css?nocache=true">
    </head>
    <body>
        <div class="sidebar">
            <div class="content">
                <article class="inline-grid">
                    <h3 style="margin-top: 0; margin-bottom: 0;">
                        a<br>
                        |&gt; context
                    </h3>
                    <p>Imagine we have the following schema:</p>

                    <pre><div class="language-tag">Elixir code</div><div class="code-container"><code><span style="color: #0000aa">defmodule</span> <span style="color: #aa0000">Orders</span>.<span style="color: #aa0000">Order</span> <span style="color: #0000aa">do</span>
<span style="color: #0000aa">  </span>alias <span style="color: #aa0000">Orders</span>.<span style="color: #aa0000">LineItems</span>

  schema <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>field <span style="color: #0000aa">:id</span>, <span style="color: #aa0000">Ecto</span>.<span style="color: #aa0000">UUID</span>
    has_many <span style="color: #0000aa">:line_items</span>, <span style="color: #aa0000">LineItems</span>
  <span style="color: #0000aa">end</span>
<span style="color: #0000aa">end</span></code></div></pre>

                    <p>The name allows you to gather some intel. First, there is a context, phoenix context, called <b>Orders</b>. This context apparently have two Ecto Models: <b>Order</b> and <b>LineItem</b>.</p>
                    <p>If you are not from another planet or part of a tribe what has been disconnected from human civilization (<em>good for them!</em>), you will guess that this might be related to e-commerce, warehousing, or something alone those lines.</p>
                    <p>That means, you are familiar with that context. For a member of that fortunate tribe, that will be nonsense. In general, as we probably you know, context matters.</p>
                    <p>However, there are contexts within contexts.</p>
                    <p>Let's add a couple more fields to our schema:</p>

                    <pre><div class="language-tag">Elixir code</div><div class="code-container"><code><span style="color: #0000aa">defmodule</span> <span style="color: #aa0000">Orders</span>.<span style="color: #aa0000">Order</span> <span style="color: #0000aa">do</span>
<span style="color: #0000aa">  </span>alias <span style="color: #aa0000">Orders</span>.{<span style="color: #aa0000">Company</span>, <span style="color: #aa0000">LineItems</span>}

  schema <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>field <span style="color: #0000aa">:id</span>, <span style="color: #aa0000">Ecto</span>.<span style="color: #aa0000">UUID</span>
    field <span style="color: #0000aa">:buyer_id</span>, <span style="color: #0000aa">:integer</span>
    field <span style="color: #0000aa">:seller_id</span>, <span style="color: #0000aa">:integer</span>
    has_many <span style="color: #0000aa">:line_items</span>, <span style="color: #aa0000">LineItems</span>
  <span style="color: #0000aa">end</span>
<span style="color: #0000aa">end</span></code></div></pre>

                    <p>A <b>Company</b> can buy and sell stuff. The transactions will be registered as <b>Order</b>s. So, how a company knows how much stuff it has sold? We can ask:

                    <pre><div class="language-tag">Elixir code</div><div class="code-container"><code>from(order <span style="color: #0000aa">in</span> <span style="color: #aa0000">Order</span>
  <span style="color: #0000aa">select:</span> order
  <span style="color: #0000aa">where:</span> order.seller_id == ^company_id
)
|&gt; <span style="color: #aa0000">Repo</span>.all()</code></div></pre>

                    <p>and it follows that we can get all the stuff a company has bought:</p>

                    <pre><div class="language-tag">Elixir code</div><div class="code-container"><code>from(order <span style="color: #0000aa">in</span> <span style="color: #aa0000">Order</span>
  <span style="color: #0000aa">select:</span> order
  <span style="color: #0000aa">where:</span> order.buyer_id == ^company_id
)
|&gt; <span style="color: #aa0000">Repo</span>.all()</code></div></pre>

                    <p>From that, we can modify our Orders context and have:</p>
                    <pre><div class="language-tag">Elixir code</div><div class="code-container"><code><span style="color: #0000aa">defmodule</span> <span style="color: #aa0000">Orders</span> <span style="color: #0000aa">do</span>
<span style="color: #0000aa">  def</span> list_sales(<span style="color: #FF0000;">%</span>{<span style="color: #0000aa">company_id:</span> company_id}) <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>from(order <span style="color: #0000aa">in</span> <span style="color: #aa0000">Order</span>
      <span style="color: #0000aa">select:</span> order
      <span style="color: #0000aa">where:</span> order.seller_id == ^company_id
    )
    |&gt; <span style="color: #aa0000">Repo</span>.all()
  <span style="color: #0000aa">end</span>

  <span style="color: #0000aa">def</span> list_purchases(<span style="color: #FF0000;">%</span>{<span style="color: #0000aa">company_id:</span> company_id}) <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>from(order <span style="color: #0000aa">in</span> <span style="color: #aa0000">Order</span>
      <span style="color: #0000aa">select:</span> order
      <span style="color: #0000aa">where:</span> order.buyer_id == ^company_id
    )
    |&gt; <span style="color: #aa0000">Repo</span>.all()
  <span style="color: #0000aa">end</span>
<span style="color: #0000aa">end</span></code></div></pre>
                    <p>We can find a way to refactor that almost identical code but that's not the point I'm chasing. What I want to do is the code to have the context in it. How can the code telling all things I need without me thinking <em>this is a purchase then I have to use the field X in order to this query to make sense</em> and so on.

                    <p>Instead of having one schema <b>Order</b>, we can have two schemas:</p>

                    <pre><div class="language-tag">Elixir code</div><div class="code-container"><code><span style="color: #0000aa">defmodule</span> <span style="color: #aa0000">Orders</span>.<span style="color: #aa0000">Purchase</span> <span style="color: #0000aa">do</span>
<span style="color: #0000aa">  </span>alias <span style="color: #aa0000">Orders</span>.{<span style="color: #aa0000">Company</span>, <span style="color: #aa0000">LineItems</span>}

  schema <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>field <span style="color: #0000aa">:id</span>, <span style="color: #aa0000">Ecto</span>.<span style="color: #aa0000">UUID</span>
    field <span style="color: #0000aa">:owner</span>, <span style="color: #0000aa">:integer</span>, <span style="color: #0000aa">source:</span> <span style="color: #0000aa">:buyer_id</span>
    field <span style="color: #0000aa">:client</span>, <span style="color: #0000aa">:integer</span>, <span style="color: #0000aa">source:</span> <span style="color: #0000aa">:seller_id</span>
    has_many <span style="color: #0000aa">:line_items</span>, <span style="color: #aa0000">LineItems</span>
  <span style="color: #0000aa">end</span>
<span style="color: #0000aa">end</span>

<span style="color: #0000aa">defmodule</span> <span style="color: #aa0000">Orders</span>.<span style="color: #aa0000">Sale</span> <span style="color: #0000aa">do</span>
<span style="color: #0000aa">  </span>alias <span style="color: #aa0000">Orders</span>.{<span style="color: #aa0000">Company</span>, <span style="color: #aa0000">LineItems</span>}

  schema <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>field <span style="color: #0000aa">:id</span>, <span style="color: #aa0000">Ecto</span>.<span style="color: #aa0000">UUID</span>
    field <span style="color: #0000aa">:client</span>, <span style="color: #0000aa">:integer</span>, <span style="color: #0000aa">source:</span> <span style="color: #0000aa">:buyer_id</span>
    field <span style="color: #0000aa">:owner</span>, <span style="color: #0000aa">:integer</span>, <span style="color: #0000aa">source:</span> <span style="color: #0000aa">:seller_id</span>
    has_many <span style="color: #0000aa">:line_items</span>, <span style="color: #aa0000">LineItems</span>
  <span style="color: #0000aa">end</span>
<span style="color: #0000aa">end</span></code></div></pre>

                    <p>This will allow us to have a better Orders context:</p>

                    <pre><div class="language-tag">Elixir code</div><div class="code-container"><code><span style="color: #0000aa">defmodule</span> <span style="color: #aa0000">Orders</span> <span style="color: #0000aa">do</span>
<span style="color: #0000aa">  def</span> list_sales(<span style="color: #FF0000;">%</span>{<span style="color: #0000aa">company_id:</span> company_id}) <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>from(sale <span style="color: #0000aa">in</span> <span style="color: #aa0000">Sale</span>
      <span style="color: #0000aa">select:</span> sale
      <span style="color: #0000aa">where:</span> sale.owner == ^company_id
    )
    |&gt; <span style="color: #aa0000">Repo</span>.all()
  <span style="color: #0000aa">end</span>

  <span style="color: #0000aa">def</span> list_purchases(<span style="color: #FF0000;">%</span>{<span style="color: #0000aa">company_id:</span> company_id}) <span style="color: #0000aa">do</span>
<span style="color: #0000aa">    </span>from(purchase <span style="color: #0000aa">in</span> <span style="color: #aa0000">Purchase</span>
      <span style="color: #0000aa">select:</span> purchase
      <span style="color: #0000aa">where:</span> purchase.owner == ^company_id
    )
    |&gt; <span style="color: #aa0000">Repo</span>.all()
  <span style="color: #0000aa">end</span>
<span style="color: #0000aa">end</span></code></div></pre>

                    <p>This will make things more readable and also the context is embedded in the code. The cons is a little bit of duplicated code but for the sake of congnitive load.</p>
                </article>
            </div>
            <div class="content flex-column">
                <br>
                <p>—</p>
                <br>
                <div>
                    <a href="/" alt="to home">to go back</a>
                </div>
            </div>
        </div>
    </body>
</html>
